<!DOCTYPE html>
<html lang="en">

<head>
    <title>SMARTeIS Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_final.css') }}">
</head>

<body>
    <div id = "dashboard">
    <h2>Welcome to SMARTeIS, {{ session['user'] }}!</h2>
    <p>Click the button at the bottom right to chat.</p>
    </div>
    <div class="chat-button" onclick="toggleChat()"> ü§ñ </div>

 <div id="chat-popup" class="chat-popup">
    <div class="chat-header">
    ü§ñ SMARTeISBot AI
    <span class="chat-header-buttons">
        <span onclick="minimizeChat()" id="minimize" style="cursor:pointer;">‚ûñ</span>
        <span onclick="resetChat()" id="cross" style="cursor:pointer;">‚úñÔ∏è</span>
    </span>
</div>


    <div class="chat-body">
        <div id="chat-box" class="chat-box">
            <div id = 'intro'>
            ü§ñ Hey, I am the SMARTeIS bot. How can I assist you today?
            </div>
        </div>

        <div id="input-area" class="input-area">
            <input type="text" id="user-input" placeholder="Ask something..." onkeydown="checkEnter(event)">
            <button type="submit" onclick="sendMessage()">Submit</button>
        </div>
    </div>
</div>
    <button class = 'logout' onclick="logout()"> Logout </button>

<script>
    function checkEnter(element){
        if (element.key === "Enter"){
            sendMessage();
        }
    }

    function toggleChat() {
    const popup = document.getElementById('chat-popup');
    popup.classList.toggle('active');

}

    function resetChat() {
        location.reload();
    }

    function minimizeChat() {
    const chatBody = document.querySelector('.chat-body');
    const minimizeBtn = document.getElementById('minimize');

    const isHidden = chatBody.classList.toggle('hidden');
    minimizeBtn.textContent = isHidden ? 'üóñ' : '‚ûñ';
}


    async function sendMessage() {
        const input = document.getElementById('user-input');
        const chatBox = document.getElementById('chat-box');
        const today = new Date();
        const time = today.toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false });

        const day = today.getDate();
        const month = today.toLocaleString('default', { month: 'long' });

        function getOrdinal(n) {
            if (n > 3 && n < 21) return n + 'th';
            switch (n % 10) {
                case 1: return n + "st";
                case 2: return n + "nd";
                case 3: return n + "rd";
                default: return n + "th";
  }
}
        const formattedDate = `${getOrdinal(day)} ${month}`;

        const msg = input.value.trim();
        if (!msg){
        alert('Please enter a question');
        return;}

        const userMsg = document.createElement('div');
        userMsg.textContent = msg;
        userMsg.className = 'chat-bubble user';
        userMsg.innerHTML = `<span class="timestamp">${formattedDate} ${time} </span><br>` + msg;
        chatBox.appendChild(userMsg);
        input.value = ''

        const loader = document.createElement('div');
        loader.className = 'thinking-indicator';
        loader.id = 'thinking-indicator';
        loader.innerHTML = `
        <div id = 'bot'>ü§ñ Bot is thinking </div>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        `;
        chatBox.append(loader)
        
        loader.style.display = 'flex';

        const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: msg })
        });

        loader.style.display = 'none';
        const data = await res.json();

        const botMsg = document.createElement('div');
        botMsg.id = 'bot-answer'
        botMsg.className = 'chat-bubble bot'; 
        botMsg.innerHTML = `<div id='bot'>ü§ñ</div><span class="timestamp">${formattedDate} ${time}</span><br>` + data.answer;
        chatBox.appendChild(botMsg);
        document.querySelectorAll('.feedback, #next-steps').forEach(el => el.remove());
        const feedback = document.createElement('div');
        feedback.className = 'feedback';
        feedback.innerHTML = 
            `<div id = feedback>
            <p><strong>Was this answer helpful?</strong></p>
            <button class="feedback-button" onclick="sendFeedback('yes')">üëç</button>
            <button class="feedback-button" onclick="sendFeedback('no')">üëé</button>
            </div>`;
        chatBox.appendChild(feedback);


    const nextSteps = document.createElement('div');
    nextSteps.id = 'next-steps';
    nextSteps.style.marginTop = '10px';
    nextSteps.innerHTML = '<strong>What can I help you with next?</strong><br>';

    const askAnother = document.createElement('button');
    askAnother.className = 'prompt';
    askAnother.textContent = 'Ask another question';
    askAnother.onclick = () => {
    input.value = '';
    input.focus();
};

    const seeSimilar = document.createElement('button');
    seeSimilar.className = 'prompt';
    seeSimilar.textContent = 'Other similar questions';
seeSimilar.onclick = () => {
    chatBox.innerHTML = '';
    chatBox.append("Here are some similar questions:");
    data['recommended questions'].forEach(question => {
    const questionButton = document.createElement('button');
    questionButton.className = 'prompt';
    questionButton.textContent = question;
    chatBox.appendChild(questionButton)
    seeSimilar.textContent = 'Other similar questions';
    questionButton.onclick = () => {
              input.value = questionButton.textContent;
        sendMessage();
    };
    
});
    
};

    chatBox.append(seeSimilar);


const contact_us = document.createElement('button');
contact_us.id = 'contact-us';
contact_us.className = 'prompt';
contact_us.textContent = 'Contact us';
contact_us.onclick = () => {
    chatBox.append("For any queries, please email us your question at query@smarte-invoicing.com and we will assist you shortly. ");}

nextSteps.appendChild(askAnother);
nextSteps.appendChild(seeSimilar);
nextSteps.appendChild(contact_us);
chatBox.appendChild(nextSteps);
chatBox.scrollTop = chatBox.scrollHeight;

    }

    async function logout(){
        const log = await fetch('/logout', {
            method : 'GET',
            headers: { 'Content-Type': 'application/json' }
        })
        if (log.ok){
            window.location.href = '/';
            
        }};

    
    function sendFeedback(type) {
        let feedbackGiven = false;
        if (feedbackGiven) return; 
        feedbackGiven = true;


        const feedbackDiv = document.getElementById('feedback');
        if (feedbackDiv) feedbackDiv.style.display = 'none';

        const chatBox = document.getElementById('chat-box'); 
        if (type === 'yes') {
            chatBox.append("Thank you for your feedback! üòä")
        } else {
            chatBox.append("We‚Äôre sorry to hear that. Please email us your query at query@smart-einvoicing.com and we will assist you shortly. ");
        }}
</script>
</body>
</html>