<!DOCTYPE html>
<html lang="en">

<head>
    <title>SMARTeIS Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_final.css') }}">
</head>

<body>
    <h2>Welcome to SMARTeIS, {{ session['user'] }}!</h2>
    <p>Click the button at the bottom right to chat.</p>
    <div class="chat-button" onclick="toggleChat()"> ü§ñ </div>

 <div id="chat-popup" class="chat-popup">
    <div class="chat-header">
        SMARTeIS Chatbot
        <span onclick="resetChat()" style="cursor:pointer;" id="cross">‚úñÔ∏è</span>
    </div>

    <div class="chat-body">
        <div id="chat-box" class="chat-box">
            ü§ñ Hey, I am the SMARTeIS bot. How can I assist you today?
            <br><br>
            Frequently Asked Questions
            <button class='prompt' onclick="sendPrompt(this)">What is SMARTeIS?</button>
            <button class='prompt' onclick="sendPrompt(this)">How to submit an invoice in SMARTeIS?</button>
        </div>

        <div id="input-area" class="input-area">
            <input type="text" id="user-input" placeholder="Ask something..." onkeydown="checkEnter(event)">
            <button type="submit" onclick="sendMessage()">Submit</button>
        </div>
    </div>
</div>
    <button class = 'logout' onclick="logout()"> Logout </button>

<script>
    function checkEnter(element){
        if (element.key === "Enter"){
            sendMessage();
        }
    }
    function sendPrompt(element){
        const question = document.getElementById('user-input');
        question.value = element.innerText;
        sendMessage();

    }
    function toggleChat() {
    const popup = document.getElementById('chat-popup');
    popup.classList.toggle('active');

}

    function resetChat() {
        location.reload();
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML = '';

        const msg = input.value.trim();
        if (!msg){
        alert('Please enter a question');
        return;}

        const userMsg = document.createElement('div');
        userMsg.textContent = msg;
        userMsg.className = 'chat-bubble user';
        chatBox.appendChild(userMsg);
        input.value = ''

        const loader = document.createElement('div');
        loader.className = 'thinking-indicator';
        loader.id = 'thinking-indicator';
        loader.innerHTML = `
        <div id = 'bot'>ü§ñ Bot is thinking </div>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        `;
        chatBox.append(loader)
        
        loader.style.display = 'flex';

        const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: msg })
        });

        loader.style.display = 'none';
        const data = await res.json();

        const botMsg = document.createElement('div');
        botMsg.id = 'bot-answer'
        botMsg.className = 'chat-bubble bot'; 
        botMsg.innerHTML = `<div id = 'bot'>ü§ñ</div> `+ data.answer;
        chatBox.appendChild(botMsg);
        const feedback = document.createElement('div');
        feedback.className = 'feedback';
        feedback.innerHTML = `
            <p><strong>Was this answer helpful?</strong></p>
            <button class="feedback-button" onclick="sendFeedback('yes')">üëç</button>
            <button class="feedback-button" onclick="sendFeedback('no')">üëé</button>
        `;
        chatBox.appendChild(feedback);


        const recommendedQuestions = document.createElement('div');
        recommendedQuestions.id = 'recommended-questions';
        recommendedQuestions.style.marginTop = '10px';
        recommendedQuestions.innerHTML = '<strong>You may be interested in:</strong><br>';
        data['recommended questions'].forEach(question => {
            const questionButton = document.createElement('button');
            questionButton.className = 'prompt';
            questionButton.textContent = question;
            questionButton.onclick = () => {
                input.value = question;
                sendMessage();
            };
            recommendedQuestions.appendChild(questionButton);
        });
        chatBox.appendChild(recommendedQuestions);


    
    }


    async function logout(){
        const log = await fetch('/logout', {
            method : 'GET',
            headers: { 'Content-Type': 'application/json' }
        })
        if (log.ok){
            window.location.href = '/';
            
        }};
    
    function sendFeedback(feedback) {
        if (feedback === 'yes') {
            alert('Thank you for your feedback!');
        } else {
            alert('We are sorry to hear that. Please email us your query at query@smart-einvoicing.com');
        }
    }     
</script>
</body>
</html>
